#!/bin/bash
DL_INSTALL_ROOT=`dirname $0`
source ${DL_INSTALL_ROOT}/util/util.sh

checkJavaVersion
showBanner

echo Data Loader installation requires you to provide an installation directory to create a version-specific subdirectory for the installation artifacts. 
echo It uses \'${HOME}\/\<relative path\>\' as the installation directory if you provide a relative path for the installation directory.
echo ""
read -p "Provide the installation directory [default: dataloader] : " INSTALLATION_DIR_NAME
INSTALLATION_DIR_NAME=${INSTALLATION_DIR_NAME:-dataloader}

[[ ${INSTALLATION_DIR_NAME} = /* ]] && DL_FULL_PATH="${INSTALLATION_DIR_NAME}/v${DATALOADER_VERSION}" || DL_FULL_PATH="${HOME}/${INSTALLATION_DIR_NAME}/v${DATALOADER_VERSION}"

echo Data Loader v$DATALOADER_VERSION will be installed in: $DL_FULL_PATH

# make sure there is a directory to install files
if [ -d "$DL_FULL_PATH" ]; then
    while true
    do
         echo ""
         echo Do you want to overwrite previously installed versions of Data Loader
         echo v$DATALOADER_VERSION and configurations in \'$DL_FULL_PATH\'?
         echo If not, installation will quit and you can restart installation using
         read -r -p "another directory.[Yes/No] " input
         case $input in
             [yY][eE][sS]|[yY])
                echo "Deleting existing Data Loader v$DATALOADER_VERSION ... "
                rm -rf "$DL_FULL_PATH"
                break
              ;;
             [nN][oO]|[nN])
                echo Data Loader installation is quitting.
                exit
              ;;
             *)
                echo "Type Yes or No."
             ;;
         esac
    done
fi

# Create symlink to dataloader shell script from the root of the installation
echo  Creating directory: $DL_FULL_PATH
mkdir -p "$DL_FULL_PATH"
SHELL_PATH=$(dirname "$0")
rsync -r "$SHELL_PATH"/.  "$DL_FULL_PATH" \
  --exclude='.*' \
  --exclude="install.command" \
  --exclude="dataloader.ico" \
  --exclude="*.zip" \
  --exclude="META-INF"
  
ln -s ${DL_FULL_PATH}/dataloader.app/Contents/MacOS/dataloader ${DL_FULL_PATH}/dataloader_console

while true
do
     echo ""
     read -r -p "Do you want to create an icon to launch Data Loader from your Desktop? [Yes/No] " input
     case $input in
         [yY][eE][sS]|[yY])
            rm   "$HOME/Desktop/DataLoader $DATALOADER_VERSION" 2>/dev/null
            ln -s  "$DL_FULL_PATH/dataloader.app"  "$HOME/Desktop/DataLoader $DATALOADER_VERSION"
            break
          ;;
         [nN][oO]|[nN])
            break
          ;;
         *)
            echo "Type Yes or No."
         ;;
     esac
done

while true
do
     echo ""
     echo "Do you want to create a link to launch Data Loader from your Applications"
     read -r -p "directory? [Yes/No] " input
     case $input in
         [yY][eE][sS]|[yY])
            rm   "/Applications/DataLoader $DATALOADER_VERSION" 2>/dev/null
            ln -s  "$DL_FULL_PATH/dataloader.app"  "/Applications/DataLoader $DATALOADER_VERSION"
            break
          ;;
         [nN][oO]|[nN])
            break
          ;;
         *)
            echo "Type Yes or No."
         ;;
     esac
done

echo  Data Loader installation is quitting.
echo ""
